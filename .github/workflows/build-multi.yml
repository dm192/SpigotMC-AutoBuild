name: Spigot å¤šç‰ˆæœ¬è‡ªåŠ¨æ„å»º
# æè¿°ï¼šè‡ªåŠ¨æ„å»º Spigot å¤šä¸ªç‰ˆæœ¬çš„ Jar åŒ…ï¼Œå¹¶ç”Ÿæˆ Release
# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘æˆ–æ¯æ—¥å®šæ—¶è§¦å‘
# éœ€è¦çš„æƒé™ï¼šå†™å…¥ä»“åº“å†…å®¹å’Œ Actions ç›¸å…³æƒé™
permissions:
  contents: write        # ç”¨äº checkoutã€download-artifactã€create tag ç­‰
  actions: write        # ç”¨äº upload-artifactã€download-artifact

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥ UTC 0:00ï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰è‡ªåŠ¨è§¦å‘

jobs:
  build:
    name: ğŸš§ æ„å»ºæ‰€æœ‰ç‰ˆæœ¬
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - spigot_version: '1.8.8'
            java_version: '8'
          - spigot_version: '1.12.2'
            java_version: '8'
          - spigot_version: '1.16.5'
            java_version: '8'
          - spigot_version: '1.17.1'
            java_version: '17'
          - spigot_version: '1.18.2'
            java_version: '17'
          - spigot_version: '1.19.4'
            java_version: '21'
          - spigot_version: '1.20.6'
            java_version: '21'
          - spigot_version: '1.21'
            java_version: '21'
          - spigot_version: '1.21.1'
            java_version: '21'
          - spigot_version: '1.21.3'
            java_version: '21'
          - spigot_version: '1.21.4'
            java_version: '21'
          - spigot_version: '1.21.5'
            java_version: '21'

    steps:
      - name: âœ”ï¸ Checkout ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ§¹ æ¸…ç† Maven æœ¬åœ°ç¼“å­˜
        run: rm -rf ~/.m2/repository

      - name: ğŸŒ ä¸‹è½½æœ€æ–° BuildTools.jar
        run: |
          wget --retry-connrefused --retry-on-http-error=429,500,502,503,504 \
               --waitretry=5 -O BuildTools.jar \
               https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar

      - name: â˜• è®¾ç½® Zulu JDK ${{ matrix.java_version }}
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java_version }}

      - name: ğŸš€ ç¼–è¯‘ Spigot ${{ matrix.spigot_version }}
        run: |
          java -jar BuildTools.jar --rev "${{ matrix.spigot_version }}"

      - name: ğŸ” æ‰¾åˆ°ç”Ÿæˆçš„ Jar
        id: rename_jar
        run: |
          ORIGINAL_JAR=$(ls spigot-*.jar | head -n1)
          NEW_JAR="spigot-${{ matrix.spigot_version }}.jar"
          if [ "$ORIGINAL_JAR" != "$NEW_JAR" ]; then
            mv "$ORIGINAL_JAR" "$NEW_JAR"
          fi
          echo "jar_name=$NEW_JAR" >> $GITHUB_OUTPUT

      - name: ğŸ” ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
        run: |
          JAR="${{ steps.rename_jar.outputs.jar_name }}"
          sha256sum "$JAR" > "${JAR}.sha256"

      - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.spigot_version }}
          path: |
            ${{ steps.rename_jar.outputs.jar_name }}
            ${{ steps.rename_jar.outputs.jar_name }}.sha256

  release:
    name: ğŸ·ï¸ ä¸Šä¼ è‡³ Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: âœ”ï¸ Checkout ä»£ç 
        uses: actions/checkout@v4
        
      - name: â±ï¸ è·å–æ—¶é—´æˆ³
        id: datetime
        run: |
          NOW=$(date -d '+8 hour' +'%Y%m%d-%H%M%S')
          echo "timestamp=$NOW" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./collected-jars

      - name: ğŸ“‹ ç”Ÿæˆç‰ˆæœ¬åˆ—è¡¨
        id: gen_versions
        run: |
          VERSIONS_MD=""
          for jar in $(find collected-jars -type f -name "spigot-*.jar"); do
            filename=$(basename "$jar")
            ver=${filename#spigot-}
            ver=${ver%.jar}
            VERSIONS_MD="$VERSIONS_MD- $ver\n"
          done
          # å»æ‰æœ€åçš„æ¢è¡Œç¬¦
          VERSIONS_MD="${VERSIONS_MD%\\n}"
          echo "versions_md<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VERSIONS_MD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ åˆ›å»º Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="AutoBuild-${{ steps.datetime.outputs.timestamp }}"
          RELEASE_NAME="AutoBuild-${{ steps.datetime.outputs.timestamp }}"

          # BODY="ğŸ‰ **è‡ªåŠ¨æ„å»ºå®Œæˆï¼**\n"
          # BODY+="\n- **æ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰**ï¼š${{ steps.datetime.outputs.timestamp }}"
          # BODY+="\n- **åŒ…å«ç‰ˆæœ¬**ï¼š"
          # BODY+="\n${{ steps.gen_versions.outputs.versions_md }}\n"
          echo "ğŸ‰ **åˆæ˜¯ä¸€æ¬¡æˆåŠŸçš„æ„å»ºï¼** " >> $BODY
          echo -e "ğŸš€ **æ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰**ï¼š${{ steps.datetime.outputs.timestamp }}" >> $BODY
          echo -e "ğŸ“¦ **åŒ…å«ç‰ˆæœ¬**ï¼š" >> $BODY
          echo -e "${{ steps.gen_versions.outputs.versions_md }}" >> $BODY
          echo -e "â­ å–œæ¬¢çš„è¯ç‚¹ä¸ª Star å§~" >> $BODY

          echo -e "$BODY"
          gh release create "$TAG" --title "$RELEASE_NAME" --notes "$BODY"

      - name: ğŸ“¦ ä¸Šä¼ æ–‡ä»¶åˆ° Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="AutoBuild-${{ steps.datetime.outputs.timestamp }}"
          for file in $(find ./collected-jars -type f \( -name "spigot-*.jar" -o -name "spigot-*.sha256" \)); do
            fname=$(basename "$file")
            echo "ä¸Šä¼  $fname åˆ° Release..."
            gh release upload "$TAG" "$file" --repo "$GITHUB_REPOSITORY"
          done

      - name: âœ… å®Œæˆ
        run: |
          echo "âœ¨ å‘å¸ƒå®Œæˆï¼šRelease AutoBuild-${{ steps.datetime.outputs.timestamp }} åŒ…å«ä»¥ä¸‹ç‰ˆæœ¬ï¼š"
          echo -e "${{ steps.gen_versions.outputs.versions_md }}"
