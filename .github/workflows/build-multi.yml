name: Spigot å¤šç‰ˆæœ¬ç»Ÿä¸€ Release

# å£°æ˜æƒé™ï¼Œç¡®ä¿ upload/download artifact å¯ä»¥æ­£å¸¸æ‰§è¡Œ
permissions:
  contents: read        # ç”¨äº checkoutã€create-release ç­‰æ“ä½œ
  actions: write        # ç”¨äº upload-artifactã€download-artifact

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥ UTC 2:00ï¼ˆåŒ—äº¬æ—¶é—´å‘¨æ—¥ 10:00ï¼‰è‡ªåŠ¨è§¦å‘

jobs:
  build:
    name: ğŸš§ çŸ©é˜µæ„å»ºæ‰€æœ‰ç‰ˆæœ¬
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - spigot_version: '1.8.8'
            java_version: '8'
          - spigot_version: '1.12.2'
            java_version: '8'
          - spigot_version: '1.17.1'
            java_version: '17'
          - spigot_version: '1.20.4'
            java_version: '17'
          - spigot_version: '1.21.1'
            java_version: '21'

    steps:
      - name: âœ”ï¸ Checkout ä»£ç 
        uses: actions/checkout@v4.2.2

      - name: ğŸ§¹ æ¸…ç† Maven æœ¬åœ°ç¼“å­˜
        run: rm -rf ~/.m2/repository

      - name: ğŸŒ ä¸‹è½½æœ€æ–° BuildTools.jar
        run: |
          curl -L -o BuildTools.jar \
            https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar

      - name: â˜• è®¾ç½® Zulu JDK ${{ matrix.java_version }}
        uses: actions/setup-java@v4.7.1
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java_version }}
          cache: 'maven'

      - name: ğŸš€ ç¼–è¯‘ Spigot ${{ matrix.spigot_version }}
        run: |
          java -jar BuildTools.jar --rev "${{ matrix.spigot_version }}"

      - name: ğŸ” æ‰¾åˆ°æ„å»ºå¥½çš„ Jar
        id: find_jar
        run: |
          JAR_FILE=$(ls spigot-*.jar | head -n1)
          echo "jar_name=$JAR_FILE" >> $GITHUB_OUTPUT

      - name: ğŸ” ç”Ÿæˆ Jar çš„ SHA256 æ ¡éªŒæ–‡ä»¶
        run: |
          JAR="${{ steps.find_jar.outputs.jar_name }}"
          sha256sum "$JAR" > "${JAR}.sha256"

      - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆArtifactï¼‰
        uses: actions/upload-artifact@v3.0.0
        with:
          name: jar-${{ matrix.spigot_version }}
          path: |
            ${{ steps.find_jar.outputs.jar_name }}
            ${{ steps.find_jar.outputs.jar_name }}.sha256

  release:
    name: ğŸ·ï¸ ç”Ÿæˆå•ä¸€ Release å¹¶ä¸Šä¼ æ‰€æœ‰ç‰ˆæœ¬
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: â±ï¸ è·å–åŒ—äº¬æ—¶é—´æˆ³
        id: datetime
        run: |
          NOW=$(date -d '+8 hour' +'%Y%m%d-%H%M%S')
          echo "timestamp=$NOW" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3.0.0
        with:
          name: jar-*
          path: ./collected-jars

      - name: ğŸ“‹ ç”Ÿæˆç‰ˆæœ¬åˆ—è¡¨ Markdown
        id: gen_versions
        run: |
          VERSIONS_MD=""
          for jar in collected-jars/spigot-*.jar; do
            filename=$(basename "$jar")
            ver=${filename#spigot-}
            ver=${ver%.jar}
            VERSIONS_MD="$VERSIONS_MD- $ver\n"
          done
          VERSIONS_MD="${VERSIONS_MD%\\n}"
          echo "versions_md<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VERSIONS_MD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ åˆ›å»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: "AutoBuild-${{ steps.datetime.outputs.timestamp }}"
          release_name: "AutoBuild-${{ steps.datetime.outputs.timestamp }}"
          body: |
            ğŸ‰ **è‡ªåŠ¨æ„å»ºå®Œæˆï¼**

            - **æ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰**ï¼š${{ steps.datetime.outputs.timestamp }}
            - **åŒ…å«ç‰ˆæœ¬**ï¼š
            ${{ steps.gen_versions.outputs.versions_md }}

            - **æ ¡éªŒæ–‡ä»¶**ï¼šæ¯ä¸ª Jar éƒ½ç”Ÿæˆäº†å¯¹åº”çš„ SHA256ï¼ˆ`.sha256`ï¼‰ï¼Œä¸‹è½½ä¹‹åå¯è‡ªè¡Œæ ¡éªŒã€‚  
            - **ä¸‹è½½æ–¹å¼**ï¼šç‚¹å‡»ä¸Šæ–¹ Release åç§°ï¼Œæ‰€æœ‰ Jar + æ ¡éªŒæ–‡ä»¶éƒ½åœ¨é™„ä»¶é‡Œã€‚  
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ ä¸Šä¼ æ‰€æœ‰ç‰ˆæœ¬å’Œæ ¡éªŒæ–‡ä»¶åˆ° Release
        run: |
          for file in ./collected-jars/spigot-*.jar ./collected-jars/spigot-*.sha256; do
            fname=$(basename "$file")
            echo "ä¸Šä¼  $fname åˆ° Release..."
            gh release upload "AutoBuild-${{ steps.datetime.outputs.timestamp }}" "$file" --repo "$GITHUB_REPOSITORY"
          done

      - name: âœ… å®Œæˆï¼šæ‰€æœ‰ç‰ˆæœ¬å·²ä¸Šä¼ 
        run: |
          echo "âœ¨ å‘å¸ƒå®Œæˆï¼šRelease AutoBuild-${{ steps.datetime.outputs.timestamp }} åŒ…å«ä»¥ä¸‹ç‰ˆæœ¬ï¼š"
          echo -e "${{ steps.gen_versions.outputs.versions_md }}"
